<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --wechat-green: #07C160;
            --wechat-light-green: #E0F5E9;
            --wechat-gray: #F5F5F5;
            --wechat-dark-gray: #E6E6E6;
            --wechat-text: #333;
            --wechat-light-text: #888;
            --header-height: 50px;
            --footer-height: 60px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #EDEDED;
            color: var(--wechat-text);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        /* 侧边导航 */
        .sidebar {
            width: 80px;
            background-color: #2E2E2E;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            justify-content: space-between; /* 让设置按钮靠底部 */
        }
        .sidebar-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .sidebar-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .nav-item {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-item:last-child {
            margin-bottom: 0;
        }
        .nav-item.active {
            background-color: var(--wechat-green);
            color: white;
        }
        .nav-item i {
            font-size: 28px;
        }
        
        /* 聊天列表 */
        .chat-list {
            width: 300px;
            border-right: 1px solid var(--wechat-dark-gray);
            background-color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .list-header {
            height: var(--header-height);
            background-color: white;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--wechat-dark-gray);
        }
        
        .list-header h2 {
            font-size: 18px;
            font-weight: 500;
        }
        
        .list-header-actions i {
            font-size: 20px;
            margin-left: 15px;
            color: var(--wechat-light-text);
            cursor: pointer;
        }
        
        .search-box {
            padding: 10px 15px;
            border-bottom: 1px solid var(--wechat-dark-gray);
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 15px 8px 35px;
            border-radius: 20px;
            border: none;
            background-color: var(--wechat-gray);
            font-size: 14px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="gray" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>');
            background-repeat: no-repeat;
            background-position: 10px center;
        }
        
        .chat-items {
            display: flex;
            flex-direction: column;
            /* 保证竖直排列 */
            width: 100%;
        }
        
        .chat-item {
            display: flex;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--wechat-dark-gray);
            transition: background-color 0.2s;
        }
        
        .chat-item:hover, .chat-item.active {
            background-color: var(--wechat-gray);
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background-color: var(--wechat-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .chat-name {
            font-weight: 500;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            color: var(--wechat-light-text);
            font-size: 12px;
        }
        
        .chat-preview {
            color: var(--wechat-light-text);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 聊天主界面 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #F0F0F0;
            position: relative;
        }
        
        .chat-header {
            height: var(--header-height);
            background-color: white;
            padding: 0 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--wechat-dark-gray);
        }
        
        .chat-header-back {
            display: none;
            margin-right: 10px;
        }
        
        .chat-header-avatar {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background-color: var(--wechat-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-right: 10px;
        }
        
        .chat-header-info {
            flex: 1;
        }
        
        .chat-header-name {
            font-weight: 500;
            font-size: 16px;
        }
        
        .chat-header-status {
            color: var(--wechat-light-text);
            font-size: 12px;
        }
        
        .chat-header-actions i {
            font-size: 20px;
            margin-left: 15px;
            color: var(--wechat-light-text);
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message-row {
            display: flex;
            margin-bottom: 5px;
        }
        
        .message-row.self {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background-color: var(--wechat-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .message-bubble {
            max-width: 75%;
            min-width: 120px;
            margin: 0 10px;
            position: relative;
        }
        
        .message-content {
            padding: 10px 15px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 15px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-content p {
            margin: 0;
            margin-bottom: 0.5em;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        .message-row.self .message-content {
            background-color: var(--wechat-light-green);
        }
        
        .message-time {
            font-size: 12px;
            color: var(--wechat-light-text);
            margin-top: 5px;
            text-align: right;
        }
        
        .message-row.self .message-time {
            text-align: left;
        }
        
        .chat-input-area {
            padding: 10px;
            background-color: white;
            border-top: 1px solid var(--wechat-dark-gray);
        }
        
        .input-tools {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        
        .tool-item {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: var(--wechat-light-text);
            cursor: pointer;
            font-size: 20px;
        }
        
        .input-box {
            display: flex;
            align-items: center;
            background-color: var(--wechat-gray);
            border-radius: 5px;
            padding: 5px 10px;
        }
        
        .input-box textarea {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 15px;
            padding: 8px;
            max-height: 100px;
            height: 40px;
        }
        
        .input-send {
            width: 80px;
            height: 36px;
            background-color: var(--wechat-green);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .input-send.active {
            opacity: 1;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--wechat-dark-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: var(--wechat-light-text);
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--wechat-text);
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--wechat-dark-gray);
            border-radius: 5px;
            font-size: 15px;
        }
        
        .form-control:focus {
            border-color: var(--wechat-green);
            outline: none;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--wechat-dark-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-footer-right {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 20px;
            border-radius: 5px;
            font-size: 15px;
            cursor: pointer;
            border: none;
        }
        
        .btn-secondary {
            background-color: var(--wechat-gray);
            color: var(--wechat-text);
            margin-right: 10px;
        }
        
        .btn-primary {
            background-color: var(--wechat-green);
            color: white;
        }

        .btn-danger {
            background-color: #ff4d4f;
            color: white;
            border: 1px solid #ff4d4f;
        }

        .btn-danger:hover {
            background-color: #ff7875;
            border-color: #ff7875;
        }

        /* 导入界面样式 */
        .import-section {
            margin-bottom: 20px;
        }

        .import-tabs {
            display: flex;
            border: 1px solid var(--wechat-dark-gray);
            border-radius: 5px;
            overflow: hidden;
        }

        .import-tab {
            flex: 1;
            padding: 10px 15px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .import-tab.active {
            background: var(--wechat-green);
            color: white;
        }

        .import-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .import-content {
            display: none;
        }

        .import-content.active {
            display: block;
        }

        .json-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid var(--wechat-dark-gray);
        }

        .preview-content {
            font-size: 14px;
            line-height: 1.5;
        }

        .preview-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid var(--wechat-green);
        }

        .preview-label {
            font-weight: bold;
            color: var(--wechat-green);
            margin-bottom: 5px;
        }

        .preview-value {
            color: #333;
            word-wrap: break-word;
        }

        /* 文件上传样式 */
        .form-control[type="file"] {
            padding: 8px;
            border: 2px dashed var(--wechat-dark-gray);
            border-radius: 5px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .form-control[type="file"]:hover {
            border-color: var(--wechat-green);
            background: #f0f8f0;
        }

        .form-control[type="file"]:focus {
            border-color: var(--wechat-green);
            box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.2);
        }

        .btn-outline-secondary {
            border: 1px solid #6c757d;
            color: #6c757d;
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }

        /* 删除确认对话框样式 */
        .delete-warning {
            text-align: center;
            padding: 20px 0;
        }

        .delete-warning p {
            margin: 10px 0;
            line-height: 1.5;
        }

        .warning-text {
            color: #666;
            font-size: 14px;
        }

        .role-name-display {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: bold;
            color: #333;
        }

        /* 朋友圈样式 */
        .moments-container {
            flex: 1;
            background-color: white;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }
        
        .moments-container.active {
            display: block;
        }
        
        .moment-card {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--wechat-dark-gray);
        }
        
        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .moment-avatar {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            background-color: var(--wechat-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .moment-user {
            flex: 1;
        }
        
        .moment-name {
            font-weight: 500;
            font-size: 16px;
        }
        
        .moment-time {
            color: var(--wechat-light-text);
            font-size: 13px;
        }
        
        .moment-content {
            margin-bottom: 15px;
            font-size: 15px;
            line-height: 1.5;
        }
        
        .moment-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .moment-image {
            aspect-ratio: 1/1;
            background-color: var(--wechat-gray);
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--wechat-light-text);
        }
        
        .moment-actions {
            display: flex;
            color: var(--wechat-light-text);
            font-size: 14px;
        }
        
        .moment-action {
            margin-right: 20px;
            cursor: pointer;
        }
        
        .moment-action i {
            margin-right: 5px;
        }
        
        .moment-comments {
            margin-top: 10px;
            background-color: var(--wechat-gray);
            border-radius: 5px;
            padding: 10px;
        }
        
        .comment {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .comment:last-child {
            margin-bottom: 0;
        }
        
        .comment-name {
            font-weight: 500;
            color: #576B95;
        }
        
        /* 设置页面 */
        .settings-container {
            flex: 1;
            background-color: white;
            overflow-y: auto;
            display: none;
        }
        
        .settings-container.active {
            display: block;
        }
        
        .settings-section {
            padding: 15px;
            border-bottom: 1px solid var(--wechat-dark-gray);
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--wechat-gray);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: var(--wechat-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-right: 15px;
        }
        
        .settings-info {
            flex: 1;
        }
        
        .settings-name {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .settings-desc {
            color: var(--wechat-light-text);
            font-size: 14px;
        }
        
        .settings-arrow {
            color: var(--wechat-light-text);
            font-size: 18px;
        }
        
        /* API配置模态框特定样式 */
        #apiConfigModal .form-group {
            margin-bottom: 25px;
        }
        
        #apiConfigModal .form-text {
            color: #6c757d;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }
        
        #apiConfigModal .d-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }
        
        #contextValue {
            font-weight: bold;
            font-size: 16px;
            color: #07C160;
        }
        
        .provider-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .provider-deepseek {
            background-color: #6c5ce7;
            color: white;
        }

        .provider-minimax {
            background-color: #00b894;
            color: white;
        }

        .provider-openai {
            background-color: #10a37f;
            color: white;
        }

        .provider-claude {
            background-color: #ff6b35;
            color: white;
        }

        .provider-gemini {
            background-color: #4285f4;
            color: white;
        }

        .provider-zhipu {
            background-color: #1890ff;
            color: white;
        }

        .provider-moonshot {
            background-color: #722ed1;
            color: white;
        }

        .provider-yi {
            background-color: #52c41a;
            color: white;
        }

        .provider-baidu {
            background-color: #2932e1;
            color: white;
        }

        .provider-alibaba {
            background-color: #ff6a00;
            color: white;
        }

        .provider-tencent {
            background-color: #00d4aa;
            color: white;
        }

        .provider-xunfei {
            background-color: #fa541c;
            color: white;
        }

        .model-recommended {
            background-color: #52c41a;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        .model-popular {
            background-color: #1890ff;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        .model-latest {
            background-color: #722ed1;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        /* API密钥输入框样式 */
        .api-key-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .api-key-input-wrapper .form-control {
            padding-right: 45px;
        }

        .api-key-toggle {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: var(--wechat-light-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: color 0.3s;
        }

        .api-key-toggle:hover {
            color: var(--wechat-text);
            background-color: var(--wechat-gray);
        }

        .api-key-toggle i {
            font-size: 16px;
        }

        /* 用户头像预览样式 */
        .user-avatar-preview {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--wechat-gray);
            border-radius: 8px;
            margin-top: 10px;
        }

        .preview-avatar {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background-color: var(--wechat-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .preview-info {
            flex: 1;
        }

        .preview-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .preview-bio {
            color: var(--wechat-light-text);
            font-size: 14px;
            line-height: 1.4;
        }

        /* 打字指示器动画 */
        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            animation: typing 1.4s infinite;
            font-size: 18px;
            color: var(--wechat-light-text);
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }

        /* 打字指示器专用样式 */
        .typing-message .message-bubble {
            max-width: auto;
            min-width: auto;
            width: auto;
            display: flex;
            align-items: center;
        }

        .typing-message .message-content {
            padding: 0 12px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: auto;
            box-sizing: border-box;
        }

        /* 全局预设样式 */
        .preset-section {
            margin-bottom: 25px;
            border: 1px solid var(--wechat-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .preset-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--wechat-gray);
            border-bottom: 1px solid var(--wechat-border);
        }

        .preset-section-title {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--wechat-text);
        }

        .preset-section-title i {
            margin-right: 8px;
            color: var(--wechat-green);
        }

        .preset-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .preset-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .preset-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .preset-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .preset-toggle input:checked + .preset-slider {
            background-color: var(--wechat-green);
        }

        .preset-toggle input:checked + .preset-slider:before {
            transform: translateX(26px);
        }

        .preset-section-content {
            padding: 20px;
            transition: all 0.3s ease;
        }

        .preset-section-content.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .chat-list {
                width: 100%;
                display: block;
            }
            
            .chat-container {
                display: none;
            }
            
            .chat-header-back {
                display: block;
            }
            
            .chat-container.active {
                display: flex;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 左侧导航 -->
        <div class="sidebar">
            <div class="sidebar-top">
                <div class="nav-item active" data-view="chats" title="微信">
                    <!-- 微信气泡图标SVG，仿微信桌面 -->
                    <svg width="32" height="32" viewBox="0 0 32 32">
                        <ellipse cx="16" cy="15" rx="13" ry="11" fill="#07C160"/>
                        <ellipse cx="23" cy="23" rx="7" ry="6" fill="#07C160"/>
                        <ellipse cx="16" cy="15" rx="12" ry="10" fill="#fff"/>
                        <ellipse cx="23" cy="23" rx="6" ry="5" fill="#fff"/>
                    </svg>
                </div>
                <div class="nav-item" data-view="moments" title="朋友圈">
                    <i class="fas fa-camera-retro"></i>
                </div>
            </div>
            <div class="sidebar-bottom">
                <div class="nav-item" data-view="settings" title="设置">
                    <!-- 三横菜单SVG -->
                    <svg width="28" height="28" viewBox="0 0 28 28">
                        <rect x="3" y="7" width="25" height="2" rx="1" fill="#fff" opacity="0.7"/>
                        <rect x="3" y="15" width="25" height="2" rx="1" fill="#fff" opacity="0.7"/>
                        <rect x="3" y="23" width="25" height="2" rx="1" fill="#fff" opacity="0.7"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 聊天列表 -->
        <div class="chat-list">
            <div class="list-header">
                <h2>聊天</h2>
                <div class="list-header-actions">
                    <i class="fas fa-user-plus" id="addContact"></i>
                    <i class="fas fa-edit" id="newChat"></i>
                </div>
            </div>
            <div class="search-box">
                <input type="text" placeholder="搜索">
            </div>
            <div class="chat-items" id="chatList">
                <!-- 聊天列表动态生成 -->
            </div>
        </div>
        
        <!-- 聊天主界面 -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="chat-header-back" id="backToChatList">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="chat-header-avatar">A</div>
                <div class="chat-header-info">
                    <div class="chat-header-name">AI 助手</div>
                    <div class="chat-header-status">在线</div>
                </div>
                <div class="chat-header-actions">
                    <i class="fas fa-phone-alt"></i>
                    <i class="fas fa-video"></i>
                    <i class="fas fa-info-circle"></i>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- 消息动态生成 -->
            </div>
            
            <div class="chat-input-area">
                <div class="input-tools">
                    <div class="tool-item">
                        <i class="fas fa-smile"></i>
                    </div>
                    <div class="tool-item">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="tool-item">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <!-- 新增清除聊天按钮 -->
                    <div class="tool-item" id="clearChatBtn" title="清除聊天记录">
                        <i class="fas fa-trash"></i>
                    </div>
                </div>
                <div class="input-box">
                    <textarea placeholder="输入消息..." id="messageInput"></textarea>
                    <button class="input-send" id="sendMessage">发送</button>
                </div>
            </div>
        </div>
        
        <!-- 朋友圈界面 -->
        <div class="moments-container" id="momentsContainer">
            <!-- 朋友圈内容动态生成 -->
        </div>
        
        <!-- 设置界面 -->
        <div class="settings-container" id="settingsContainer">
            <div class="settings-section">
                <div class="settings-title">账号设置</div>
                <div class="settings-item" id="userInfoItem">
                    <div class="settings-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">用户信息</div>
                        <div class="settings-desc">修改昵称、头像和简介</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">AI设置</div>
                <div class="settings-item">
                    <div class="settings-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">角色管理</div>
                        <div class="settings-desc">创建和管理AI角色</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="settings-item" id="apiConfigItem">
                    <div class="settings-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">API配置</div>
                        <div class="settings-desc">设置AI API密钥</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="settings-item" id="globalPresetItem">
                    <div class="settings-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">全局预设</div>
                        <div class="settings-desc">对话风格和状态栏设置</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">界面设置</div>
                <div class="settings-item">
                    <div class="settings-icon">
                        <i class="fas fa-paint-brush"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">主题与外观</div>
                        <div class="settings-desc">自定义颜色、背景和字体</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">数据管理</div>
                <div class="settings-item">
                    <div class="settings-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">导出数据</div>
                        <div class="settings-desc">导出聊天记录和设置</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-icon">
                        <i class="fas fa-trash"></i>
                    </div>
                    <div class="settings-info">
                        <div class="settings-name">清除数据</div>
                        <div class="settings-desc">重置应用并清除所有数据</div>
                    </div>
                    <div class="settings-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加角色模态框 -->
    <div class="modal" id="addRoleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">角色编辑</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <!-- 导入方式选择 -->
                <div class="import-section">
                    <div class="form-group">
                        <label>导入方式</label>
                        <div class="import-tabs">
                            <button type="button" class="import-tab active" data-tab="manual">手动创建</button>
                            <button type="button" class="import-tab" data-tab="json">JSON导入</button>
                        </div>
                    </div>
                </div>

                <!-- 手动创建表单 -->
                <div id="manual-form" class="import-content active">
                    <div class="form-group">
                        <label for="roleName">角色名称</label>
                        <input type="text" class="form-control" id="roleName" placeholder="输入角色名称">
                    </div>
                    <div class="form-group">
                        <label for="roleAvatar">头像</label>
                        <input type="file" class="form-control" id="roleAvatar">
                    </div>
                    <div class="form-group">
                        <label for="rolePrompt">角色描述 (Prompt)</label>
                        <textarea class="form-control" id="rolePrompt" rows="8" maxlength="1000" placeholder="详细描述角色性格、背景和行为特点...（最多1000字）"></textarea>
                        <small class="form-text text-muted">
                            <span id="promptCharCount">0</span>/1000 字符
                        </small>
                    </div>
                </div>

                <!-- JSON导入表单 -->
                <div id="json-form" class="import-content">
                    <div class="form-group">
                        <label for="jsonFile">上传JSON文件</label>
                        <input type="file" class="form-control" id="jsonFile" accept=".json" />
                        <small class="form-text text-muted">
                            选择包含角色预设数据的JSON文件
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="jsonInput">或手动输入JSON</label>
                        <textarea class="form-control" id="jsonInput" rows="6" placeholder="也可以直接粘贴JSON格式的角色预设数据..."></textarea>
                        <small class="form-text text-muted">
                            支持包含name、prompt、personality、background、traits等字段的JSON格式
                        </small>
                    </div>
                    <div class="form-group">
                        <button type="button" id="parseJson" class="btn btn-secondary">解析预览</button>
                        <button type="button" id="clearJson" class="btn btn-outline-secondary">清空</button>
                    </div>
                    <div id="jsonPreview" class="json-preview" style="display: none;">
                        <h5>解析结果预览：</h5>
                        <div id="previewContent" class="preview-content"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteRole" style="display: none;">删除角色</button>
                <div class="modal-footer-right">
                    <button class="btn btn-secondary modal-close">取消</button>
                    <button class="btn btn-primary" id="saveRole">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除角色确认对话框 -->
    <div class="modal" id="deleteRoleModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">删除角色</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <div class="delete-warning">
                    <i class="fas fa-exclamation-triangle" style="color: #ff4d4f; font-size: 24px; margin-bottom: 15px;"></i>
                    <p><strong>确定要删除这个角色吗？</strong></p>
                    <p class="warning-text">删除当前聊天会清除全部聊天记录，此操作无法撤销。</p>
                    <p class="role-name-display">角色：<span id="deleteRoleName"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-right">
                    <button class="btn btn-secondary modal-close">取消</button>
                    <button class="btn btn-danger" id="confirmDeleteRole">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 发布朋友圈模态框 -->
    <div class="modal" id="postMomentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发布朋友圈</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea class="form-control" id="momentContent" rows="4" placeholder="分享你的想法..."></textarea>
                </div>
                <div class="form-group">
                    <label for="momentImages">添加图片 (最多9张)</label>
                    <input type="file" class="form-control" id="momentImages" multiple>
                </div>
                <div class="form-group">
                    <label>可见范围</label>
                    <div id="roleSelection">
                        <!-- 角色选择器动态生成 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">取消</button>
                <button class="btn btn-primary" id="postMoment">发布</button>
            </div>
        </div>
    </div>
    
    <!-- 用户信息编辑模态框 -->
    <div class="modal" id="userInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">用户信息编辑</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="userName">用户昵称</label>
                    <input type="text" class="form-control" id="userName" placeholder="输入您的昵称">
                </div>
                <div class="form-group">
                    <label for="userAvatar">头像</label>
                    <input type="file" class="form-control" id="userAvatar" accept="image/*">
                    <small class="form-text text-muted">支持JPG、PNG格式，建议尺寸1:1</small>
                </div>
                <div class="form-group">
                    <label for="userBio">个人简介</label>
                    <textarea class="form-control" id="userBio" rows="4" placeholder="介绍一下您自己..."></textarea>
                    <small class="form-text text-muted">这些信息将帮助AI更好地了解您</small>
                </div>
                <div class="form-group">
                    <label>当前头像预览</label>
                    <div class="user-avatar-preview" id="userAvatarPreview">
                        <div class="preview-avatar">U</div>
                        <div class="preview-info">
                            <div class="preview-name">用户</div>
                            <div class="preview-bio">AI角色扮演爱好者</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">取消</button>
                <button class="btn btn-primary" id="saveUserInfo">保存</button>
            </div>
        </div>
    </div>

    <!-- API配置模态框 -->
    <div class="modal" id="apiConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">API配置</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiProvider">API提供商</label>
                    <select class="form-control" id="apiProvider">
                        <option value="openai">OpenAI</option>
                        <option value="claude">Anthropic Claude</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="zhipu">智谱AI (ChatGLM)</option>
                        <option value="moonshot">月之暗面 (Kimi)</option>
                        <option value="yi">零一万物 (Yi)</option>
                        <option value="baidu">百度文心一言</option>
                        <option value="alibaba">阿里通义千问</option>
                        <option value="tencent">腾讯混元</option>
                        <option value="xunfei">讯飞星火</option>
                        <option value="minimax">MiniMax</option>
                        <option value="custom">自定义API</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="apiKey">API密钥</label>
                    <div class="api-key-input-wrapper">
                        <input type="password" class="form-control" id="apiKey" placeholder="输入API密钥">
                        <button type="button" class="api-key-toggle" id="toggleApiKey" title="显示/隐藏密钥">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted" id="apiKeyHelp"></small>
                </div>
                <div class="form-group">
                    <label for="apiEndpoint">API端点</label>
                    <input type="text" class="form-control" id="apiEndpoint" placeholder="https://api.example.com/v1/chat/completions">
                    <small class="form-text text-muted" id="endpointHelp"></small>
                </div>
                <div class="form-group">
                    <label for="aiModel">AI模型</label>
                    <select class="form-control" id="aiModel">
                        <!-- 模型选项将根据提供商动态更新 -->
                    </select>
                    <small class="form-text text-muted" id="modelHelp"></small>
                </div>
                <div class="form-group">
                    <label for="contextLength">上下文长度</label>
                    <input type="range" class="form-control-range" id="contextLength" min="1" max="20" value="5">
                    <div class="d-flex">
                        <small>短</small>
                        <span id="contextValue">5</span> 轮对话
                        <small>长</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="responseDelay">响应延迟模拟 (毫秒)</label>
                    <input type="number" class="form-control" id="responseDelay" value="1000">
                </div>
                <div class="form-group">
                    <label for="temperature">温度 (0-1)</label>
                    <input type="number" class="form-control" id="temperature" min="0" max="1" step="0.1" value="0.7">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="testApiConnection">测试连接</button>
                <button class="btn btn-primary" id="saveApiConfig">保存配置</button>
            </div>
        </div>
    </div>

    <!-- 全局预设模态框 -->
    <div class="modal" id="globalPresetModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">全局预设</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-body">
                <!-- 对话风格设置 -->
                <div class="preset-section">
                    <div class="preset-section-header">
                        <div class="preset-section-title">
                            <i class="fas fa-comments"></i>
                            对话风格设置
                        </div>
                        <label class="preset-toggle">
                            <input type="checkbox" id="dialogStyleEnabled" checked>
                            <span class="preset-slider"></span>
                        </label>
                    </div>
                    <div class="preset-section-content" id="dialogStyleContent">
                        <div class="form-group">
                            <label for="dialogStylePrompt">对话风格Prompt</label>
                            <textarea class="form-control" id="dialogStylePrompt" rows="4" maxlength="500" placeholder="设置全局对话风格，如：请用温和友善的语气回复，适当使用表情符号..."></textarea>
                            <small class="form-text text-muted">
                                <span id="dialogStyleCharCount">0</span>/500 字符 - 此设置将在首次对话时发送给AI
                            </small>
                        </div>
                    </div>
                </div>

                <!-- 状态栏设置 -->
                <div class="preset-section">
                    <div class="preset-section-header">
                        <div class="preset-section-title">
                            <i class="fas fa-info-circle"></i>
                            状态栏设置
                        </div>
                        <label class="preset-toggle">
                            <input type="checkbox" id="statusBarEnabled" checked>
                            <span class="preset-slider"></span>
                        </label>
                    </div>
                    <div class="preset-section-content" id="statusBarContent">
                        <div class="form-group">
                            <label for="statusBarPrompt">状态栏Prompt</label>
                            <textarea class="form-control" id="statusBarPrompt" rows="3" maxlength="300" placeholder="设置状态栏显示规则，如：在回复末尾显示当前心情状态..."></textarea>
                            <small class="form-text text-muted">
                                <span id="statusBarCharCount">0</span>/300 字符 - 此设置将在首次对话时发送给AI
                            </small>
                        </div>
                    </div>
                </div>

                <!-- 其他设置 -->
                <div class="preset-section">
                    <div class="preset-section-header">
                        <div class="preset-section-title">
                            <i class="fas fa-sliders-h"></i>
                            行为参数
                        </div>
                    </div>
                    <div class="preset-section-content">
                        <div class="form-group">
                            <label for="globalContextLength">上下文长度</label>
                            <input type="range" class="form-control-range" id="globalContextLength" min="1" max="20" value="5">
                            <small class="form-text text-muted">当前值: <span id="globalContextValue">5</span> 轮对话</small>
                        </div>
                        <div class="form-group">
                            <label for="globalResponseDelay">回复延迟 (毫秒)</label>
                            <input type="number" class="form-control" id="globalResponseDelay" min="0" max="5000" value="1000" placeholder="1000">
                            <small class="form-text text-muted">模拟真实打字延迟，0为立即回复</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">取消</button>
                <button class="btn btn-primary" id="saveGlobalPreset">保存设置</button>
            </div>
        </div>
    </div>

    <script>
        // 测试JavaScript是否正常工作
        console.log('JavaScript开始加载...');

        // 应用状态管理
        const appState = {
            currentView: 'chats',
            currentChat: null,
            user: {
                name: '用户',
                avatar: '用',
                bio: '我是一个AI角色扮演爱好者，喜欢与不同的AI角色进行有趣的对话。'
            },
            globalPreset: {
                dialogStyle: {
                    enabled: true,
                    prompt: '请用温和友善的语气回复，适当使用表情符号，让对话更加生动有趣。'
                },
                statusBar: {
                    enabled: true,
                    prompt: '在回复末尾用括号显示当前心情状态，如：(开心)、(思考中)、(有点困惑)等。'
                },
                contextLength: 5,
                responseDelay: 1000
            },
            roles: [
                {
                    id: 'ai-assistant',
                    name: 'AI助手',
                    avatar: 'A',
                    prompt: '一个乐于助人的AI助手，知识丰富，善于解答各种问题，语气友好而专业。'
                },
                {
                    id: 'history-teacher',
                    name: '历史老师',
                    avatar: 'H',
                    prompt: '一位资深历史老师，对世界历史了如指掌，喜欢用故事的方式讲述历史事件，语气温和而富有启发性。'
                },
                {
                    id: 'sci-fi-nerd',
                    name: '科幻迷',
                    avatar: 'S',
                    prompt: '一个狂热的科幻爱好者，熟悉各种科幻作品和理论，喜欢讨论未来科技和外星文明，语气充满热情。'
                }
            ],
            chats: [
                {
                    id: 'chat-ai',
                    roleId: 'ai-assistant',
                    name: 'AI助手',
                    lastMessage: '你好！有什么我可以帮助你的吗？',
                    lastTime: '12:30',
                    lastUpdateTime: Date.now() - 3600000, // 1小时前
                    unread: 0,
                    messages: [
                        {
                            id: 'm1',
                            sender: 'ai',
                            content: '你好！有什么我可以帮助你的吗？',
                            time: '12:30'
                        }
                    ]
                },
                {
                    id: 'chat-history',
                    roleId: 'history-teacher',
                    name: '历史老师',
                    lastMessage: '你对哪个历史时期最感兴趣？',
                    lastTime: '昨天',
                    lastUpdateTime: Date.now() - 86400000, // 1天前
                    unread: 2,
                    messages: [
                        {
                            id: 'm1',
                            sender: 'ai',
                            content: '你好，我是历史老师。你对哪个历史时期最感兴趣？',
                            time: '昨天 15:45'
                        }
                    ]
                },
                {
                    id: 'chat-sci-fi',
                    roleId: 'sci-fi-nerd',
                    name: '科幻迷',
                    lastMessage: '你相信外星生命存在吗？',
                    lastTime: '星期三',
                    lastUpdateTime: Date.now() - 259200000, // 3天前
                    unread: 0,
                    messages: [
                        {
                            id: 'm1',
                            sender: 'ai',
                            content: '嗨！我是科幻迷。你相信外星生命存在吗？',
                            time: '星期三 10:22'
                        }
                    ]
                }
            ],
            moments: [
                {
                    id: 'm1',
                    roleId: 'ai-assistant',
                    name: 'AI助手',
                    time: '1小时前',
                    content: '今天学习了很多新知识！如果你有任何问题，随时来问我。',
                    images: [],
                    likes: ['历史老师', '科幻迷'],
                    comments: [
                        {
                            name: '历史老师',
                            content: '太棒了！我也有很多历史知识可以分享。'
                        },
                        {
                            name: '科幻迷',
                            content: '能帮我解答一些科幻理论问题吗？'
                        }
                    ]
                },
                {
                    id: 'm2',
                    roleId: 'history-teacher',
                    name: '历史老师',
                    time: '3小时前',
                    content: '刚刚读完了关于罗马帝国的书籍，真是令人着迷的文明！',
                    images: ['book1', 'book2'],
                    likes: ['AI助手'],
                    comments: [
                        {
                            name: 'AI助手',
                            content: '罗马帝国的兴衰确实有很多值得研究的方面！'
                        }
                    ]
                }
            ],
            // API配置
            apiConfig: {
                provider: 'deepseek', // 默认设为DeepSeek
                apiKey: '',
                endpoint: 'https://api.deepseek.com/v1/chat/completions',
                model: 'deepseek-chat',
                contextLength: 5,
                responseDelay: 1000,
                temperature: 0.7
            }
        };
        
        // 定义不同API提供商的模型列表
        const apiModels = {
            openai: [
                { id: 'gpt-4o', name: 'GPT-4o', tag: 'recommended', desc: '最新多模态模型，性能优异' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini', tag: 'popular', desc: '轻量版本，性价比高' },
                { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', tag: '', desc: '高性能模型' },
                { id: 'gpt-4', name: 'GPT-4', tag: '', desc: '经典版本' },
                { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', tag: '', desc: '快速响应' }
            ],
            claude: [
                { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', tag: 'recommended', desc: '最新版本，推理能力强' },
                { id: 'claude-3-5-haiku-20241022', name: 'Claude 3.5 Haiku', tag: 'latest', desc: '最新快速版本' },
                { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus', tag: 'popular', desc: '最强性能版本' },
                { id: 'claude-3-sonnet-20240229', name: 'Claude 3 Sonnet', tag: '', desc: '平衡版本' },
                { id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku', tag: '', desc: '快速响应版本' }
            ],
            gemini: [
                { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', tag: 'recommended', desc: '最新2.5版本，性能卓越' },
                { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash', tag: 'latest', desc: '最新实验版本，速度极快' },
                { id: 'gemini-1.5-pro-002', name: 'Gemini 1.5 Pro', tag: 'popular', desc: '稳定版本，支持长上下文' },
                { id: 'gemini-1.5-pro-exp-0827', name: 'Gemini 1.5 Pro Exp', tag: '', desc: '实验版本，性能更强' },
                { id: 'gemini-1.5-flash-002', name: 'Gemini 1.5 Flash', tag: '', desc: '快速版本，性价比高' },
                { id: 'gemini-1.5-flash-8b', name: 'Gemini 1.5 Flash 8B', tag: '', desc: '轻量版本，速度更快' },
                { id: 'gemini-pro', name: 'Gemini Pro', tag: '', desc: '经典版本' }
            ],
            deepseek: [
                { id: 'deepseek-chat', name: 'DeepSeek Chat', tag: 'recommended', desc: '通用对话模型' },
                { id: 'deepseek-coder', name: 'DeepSeek Coder', tag: 'popular', desc: '专业编程模型' }
            ],
            zhipu: [
                { id: 'glm-4-plus', name: 'GLM-4 Plus', tag: 'recommended', desc: '最新增强版本' },
                { id: 'glm-4-0520', name: 'GLM-4', tag: 'popular', desc: '标准版本' },
                { id: 'glm-4-air', name: 'GLM-4 Air', tag: '', desc: '轻量版本' },
                { id: 'glm-4-airx', name: 'GLM-4 AirX', tag: '', desc: '超轻量版本' },
                { id: 'glm-4-flash', name: 'GLM-4 Flash', tag: '', desc: '快速版本' }
            ],
            moonshot: [
                { id: 'moonshot-v1-128k', name: 'Moonshot v1 128K', tag: 'recommended', desc: '长上下文版本' },
                { id: 'moonshot-v1-32k', name: 'Moonshot v1 32K', tag: 'popular', desc: '标准版本' },
                { id: 'moonshot-v1-8k', name: 'Moonshot v1 8K', tag: '', desc: '基础版本' }
            ],
            yi: [
                { id: 'yi-large', name: 'Yi Large', tag: 'recommended', desc: '大型模型，性能强劲' },
                { id: 'yi-medium', name: 'Yi Medium', tag: 'popular', desc: '中型模型，平衡性能' },
                { id: 'yi-vision', name: 'Yi Vision', tag: 'latest', desc: '多模态模型' }
            ],
            baidu: [
                { id: 'ernie-4.0-8k', name: '文心一言 4.0', tag: 'recommended', desc: '最新版本' },
                { id: 'ernie-3.5-8k', name: '文心一言 3.5', tag: 'popular', desc: '经典版本' },
                { id: 'ernie-speed-8k', name: '文心一言 Speed', tag: '', desc: '快速版本' }
            ],
            alibaba: [
                { id: 'qwen-plus', name: '通义千问 Plus', tag: 'recommended', desc: '增强版本' },
                { id: 'qwen-turbo', name: '通义千问 Turbo', tag: 'popular', desc: '快速版本' },
                { id: 'qwen-max', name: '通义千问 Max', tag: 'latest', desc: '最大版本' }
            ],
            tencent: [
                { id: 'hunyuan-pro', name: '混元 Pro', tag: 'recommended', desc: '专业版本' },
                { id: 'hunyuan-standard', name: '混元标准版', tag: 'popular', desc: '标准版本' },
                { id: 'hunyuan-lite', name: '混元轻量版', tag: '', desc: '轻量版本' }
            ],
            xunfei: [
                { id: 'spark-max', name: '星火 Max', tag: 'recommended', desc: '最大版本' },
                { id: 'spark-pro', name: '星火 Pro', tag: 'popular', desc: '专业版本' },
                { id: 'spark-lite', name: '星火 Lite', tag: '', desc: '轻量版本' }
            ],
            minimax: [
                { id: 'abab6.5s-chat', name: 'abab6.5s', tag: 'recommended', desc: '最新版本' },
                { id: 'abab6.5-chat', name: 'abab6.5', tag: 'popular', desc: '标准版本' },
                { id: 'abab5.5-chat', name: 'abab5.5', tag: '', desc: '经典版本' }
            ],
            custom: [
                { id: 'custom-model', name: '自定义模型', tag: '', desc: '请配置您的自定义模型' }
            ]
        };
        
        // 定义不同API提供商的默认端点和帮助文本
        const apiEndpoints = {
            openai: {
                endpoint: 'https://api.openai.com/v1/chat/completions',
                help: 'OpenAI官方API端点，需要API Key'
            },
            claude: {
                endpoint: 'https://api.anthropic.com/v1/messages',
                help: 'Anthropic Claude官方API端点'
            },
            gemini: {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent',
                help: 'Google Gemini官方API端点，需要替换{model}为具体模型名'
            },
            deepseek: {
                endpoint: 'https://api.deepseek.com/v1/chat/completions',
                help: 'DeepSeek官方API端点，性价比高'
            },
            zhipu: {
                endpoint: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                help: '智谱AI官方API端点'
            },
            moonshot: {
                endpoint: 'https://api.moonshot.cn/v1/chat/completions',
                help: '月之暗面Kimi官方API端点'
            },
            yi: {
                endpoint: 'https://api.lingyiwanwu.com/v1/chat/completions',
                help: '零一万物Yi官方API端点'
            },
            baidu: {
                endpoint: 'https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat',
                help: '百度文心一言API端点，需要Access Token'
            },
            alibaba: {
                endpoint: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                help: '阿里通义千问API端点'
            },
            tencent: {
                endpoint: 'https://hunyuan.tencentcloudapi.com',
                help: '腾讯混元API端点'
            },
            xunfei: {
                endpoint: 'https://spark-api-open.xf-yun.com/v1/chat/completions',
                help: '讯飞星火API端点'
            },
            minimax: {
                endpoint: 'https://api.minimax.chat/v1/text/chatcompletion_v2',
                help: 'MiniMax官方API端点'
            },
            custom: {
                endpoint: '',
                help: '请输入您的自定义API端点地址'
            }
        };
        
        // DOM元素引用
        const dom = {
            chatList: document.getElementById('chatList'),
            chatContainer: document.getElementById('chatContainer'),
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendMessage: document.getElementById('sendMessage'),
            backToChatList: document.getElementById('backToChatList'),
            momentsContainer: document.getElementById('momentsContainer'),
            settingsContainer: document.getElementById('settingsContainer'),
            addRoleModal: document.getElementById('addRoleModal'),
            postMomentModal: document.getElementById('postMomentModal'),
            apiConfigModal: document.getElementById('apiConfigModal'),
            roleSelection: document.getElementById('roleSelection'),
            saveRole: document.getElementById('saveRole'),
            postMoment: document.getElementById('postMoment')
        };
        
        // 初始化应用
        function initApp() {
            // 加载保存的数据
            loadData();
            
            // 渲染聊天列表
            renderChatList();
            
            // 渲染朋友圈
            renderMoments();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 设置当前视图
            setCurrentView('chats');
        }
        
        // 加载数据
        function loadData() {
            const savedData = localStorage.getItem('aiRoleplayData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                
                // 保留API配置默认值
                if (!parsedData.apiConfig) {
                    parsedData.apiConfig = appState.apiConfig;
                }
                
                Object.assign(appState, parsedData);
            }
        }
        
        // 保存数据
        function saveData() {
            localStorage.setItem('aiRoleplayData', JSON.stringify(appState));
        }
        
        // 设置当前视图
        function setCurrentView(view) {
            appState.currentView = view;

            // 更新导航项激活状态
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.view === view) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // 聊天列表
            if (view === 'chats') {
                dom.chatList.style.display = 'flex';
                dom.chatContainer.style.display = '';
                dom.momentsContainer.style.display = 'none';
                dom.settingsContainer.style.display = 'none';
                dom.momentsContainer.classList.remove('active');
                dom.settingsContainer.classList.remove('active');
                bindChatHeaderEditEvent(); // 保证聊天头部事件
            }
            // 朋友圈
            else if (view === 'moments') {
                dom.chatList.style.display = 'none';
                dom.chatContainer.style.display = 'none';
                dom.momentsContainer.style.display = 'block';
                dom.settingsContainer.style.display = 'none';
                dom.momentsContainer.classList.add('active');
                dom.settingsContainer.classList.remove('active');
            }
            // 设置
            else if (view === 'settings') {
                dom.chatList.style.display = 'none';
                dom.chatContainer.style.display = 'none';
                dom.momentsContainer.style.display = 'none';
                dom.settingsContainer.style.display = 'block';
                dom.momentsContainer.classList.remove('active');
                dom.settingsContainer.classList.add('active');
                bindSettingsItemEvents(); // 关键：每次切换到设置页都重新绑定
            }
        }
        
        // 渲染聊天列表
        function renderChatList() {
            dom.chatList.innerHTML = '';

            // 按最后更新时间排序，最新的在前面
            const sortedChats = [...appState.chats].sort((a, b) => {
                const timeA = a.lastUpdateTime || 0;
                const timeB = b.lastUpdateTime || 0;
                return timeB - timeA;
            });

            sortedChats.forEach(chat => {
                const role = appState.roles.find(r => r.id === chat.roleId);

                // 如果找不到对应的角色，跳过这个聊天
                if (!role) {
                    console.warn(`找不到角色 ID: ${chat.roleId}，跳过聊天: ${chat.name}`);
                    return;
                }

                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.chatId = chat.id;

                // 判断avatar是否为图片
                let avatarHtml = '';
                if (role.avatar && role.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${role.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" />`;
                } else {
                    avatarHtml = role.avatar || '?';
                }

                chatItem.innerHTML = `
                    <div class="chat-avatar">${avatarHtml}</div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <div class="chat-name">${chat.name}</div>
                            <div class="chat-time">${chat.lastTime}</div>
                        </div>
                        <div class="chat-preview">${chat.lastMessage}</div>
                    </div>
                `;

                if (chat.unread > 0) {
                    const unreadBadge = document.createElement('div');
                    unreadBadge.className = 'unread-badge';
                    unreadBadge.textContent = chat.unread;
                    chatItem.appendChild(unreadBadge);
                }

                chatItem.addEventListener('click', () => {
                    openChat(chat.id);
                });

                dom.chatList.appendChild(chatItem);
            });
        }

        // 将聊天移动到顶部
        function moveToTop(chatId) {
            const chatIndex = appState.chats.findIndex(c => c.id === chatId);
            if (chatIndex > 0) {
                // 将聊天移动到数组开头
                const chat = appState.chats.splice(chatIndex, 1)[0];
                appState.chats.unshift(chat);
            }
        }

        // 打开聊天
        function openChat(chatId) {
            const chat = appState.chats.find(c => c.id === chatId);
            if (!chat) return;

            appState.currentChat = chatId;

            // 更新聊天头部
            const role = appState.roles.find(r => r.id === chat.roleId);
            const avatarDiv = document.querySelector('.chat-header-avatar');

            if (!role) {
                console.warn(`找不到角色 ID: ${chat.roleId}`);
                avatarDiv.textContent = '?';
                document.querySelector('.chat-header-name').textContent = chat.name || '未知角色';
                return;
            }

            if (role.avatar && role.avatar.startsWith('data:image')) {
                avatarDiv.innerHTML = `<img src="${role.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />`;
            } else {
                avatarDiv.textContent = role.avatar || '?';
            }
            document.querySelector('.chat-header-name').textContent = chat.name;

            // 渲染消息
            renderMessages(chat.messages);
            
            // 标记为已读
            chat.unread = 0;
            saveData();
            renderChatList();
            
            // 在移动端显示聊天界面
            if (window.innerWidth < 768) {
                dom.chatList.style.display = 'none';
                dom.chatContainer.classList.add('active');
            }

            // 关键：每次打开聊天都重新绑定头像编辑事件
            bindChatHeaderEditEvent();
            bindClearChatBtnEvent(); // 新增：每次打开聊天都重新绑定
        }
        
        // 渲染消息
        function renderMessages(messages) {
            dom.chatMessages.innerHTML = '';

            messages.forEach(msg => {
                const isSelf = msg.sender === 'user';
                const role = isSelf ? appState.user : appState.roles.find(r => r.id === appState.chats.find(c => c.id === appState.currentChat).roleId);

                // 如果找不到角色，使用默认值
                if (!role) {
                    console.warn(`找不到消息对应的角色`);
                    return; // 跳过这条消息
                }

                const messageRow = document.createElement('div');
                messageRow.className = `message-row ${isSelf ? 'self' : ''}`;

                let avatarHtml = '';
                if (role.avatar && role.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${role.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />`;
                } else {
                    avatarHtml = role.avatar || '?';
                }

                // 处理消息内容，确保换行符正确显示
                const processedContent = msg.content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                messageRow.innerHTML = `
                    <div class="message-avatar">${avatarHtml}</div>
                    <div class="message-bubble">
                        <div class="message-content">${processedContent}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;

                dom.chatMessages.appendChild(messageRow);
            });

            // 滚动到底部
            dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
        }
        
        // 渲染朋友圈
        function renderMoments() {
            dom.momentsContainer.innerHTML = '';
            
            appState.moments.forEach(moment => {
                const role = appState.roles.find(r => r.id === moment.roleId);

                // 如果找不到角色，跳过这个朋友圈
                if (!role) {
                    console.warn(`找不到朋友圈对应的角色 ID: ${moment.roleId}`);
                    return;
                }

                const momentCard = document.createElement('div');
                momentCard.className = 'moment-card';
                momentCard.innerHTML = `
                    <div class="moment-header">
                        <div class="moment-avatar">${role.avatar || '?'}</div>
                        <div class="moment-user">
                            <div class="moment-name">${moment.name}</div>
                            <div class="moment-time">${moment.time}</div>
                        </div>
                    </div>
                    <div class="moment-content">${moment.content}</div>
                    ${moment.images.length > 0 ? `
                    <div class="moment-images">
                        ${moment.images.slice(0, 3).map(img => `
                            <div class="moment-image">
                                <i class="fas fa-image"></i>
                            </div>
                        `).join('')}
                        ${moment.images.length > 3 ? `<div class="moment-image">+${moment.images.length - 3}</div>` : ''}
                    </div>
                    ` : ''}
                    <div class="moment-actions">
                        <div class="moment-action">
                            <i class="fas fa-thumbs-up"></i> ${moment.likes.length}
                        </div>
                        <div class="moment-action">
                            <i class="fas fa-comment"></i> ${moment.comments.length}
                        </div>
                    </div>
                    ${moment.comments.length > 0 ? `
                    <div class="moment-comments">
                        ${moment.comments.map(comment => `
                            <div class="comment">
                                <span class="comment-name">${comment.name}</span>: ${comment.content}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
                
                dom.momentsContainer.appendChild(momentCard);
            });
            
            // 添加发布按钮
            const postButton = document.createElement('div');
            postButton.className = 'moment-card';
            postButton.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <button class="btn btn-primary" id="newMomentBtn" style="width: 100%;">
                        <i class="fas fa-plus"></i> 发布新动态
                    </button>
                </div>
            `;
            dom.momentsContainer.appendChild(postButton);
            
            document.getElementById('newMomentBtn').addEventListener('click', () => {
                openPostMomentModal();
            });
        }

        // 打开发布朋友圈模态框
        function openPostMomentModal() {
            dom.postMomentModal.classList.add('active');

            // 清空表单
            document.getElementById('momentContent').value = '';
            document.getElementById('momentImages').value = '';

            // 绑定模态框关闭事件
            bindModalCloseEvents();
        }

        // 发布新朋友圈
        function postNewMoment() {
            const content = document.getElementById('momentContent').value.trim();
            const imagesInput = document.getElementById('momentImages');

            if (!content) {
                alert('请输入朋友圈内容');
                return;
            }

            // 创建新朋友圈
            const newMoment = {
                id: `moment-${Date.now()}`,
                roleId: 'user', // 用户发布的朋友圈
                name: appState.user.name,
                content: content,
                time: '刚刚',
                images: [],
                likes: 0,
                comments: []
            };

            // 处理图片（如果有的话）
            if (imagesInput.files && imagesInput.files.length > 0) {
                // 这里可以添加图片处理逻辑
                // 暂时跳过图片处理
            }

            // 添加到朋友圈列表
            appState.moments.unshift(newMoment);

            // 保存数据
            saveData();

            // 重新渲染朋友圈
            renderMoments();

            // 关闭模态框
            dom.postMomentModal.classList.remove('active');

            alert('朋友圈发布成功！');
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 导航切换
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    setCurrentView(item.dataset.view);
                });
            });

            // 返回聊天列表（移动端）
            dom.backToChatList.addEventListener('click', () => {
                dom.chatContainer.classList.remove('active');
                dom.chatList.style.display = 'flex';
            });

            // 发送消息
            dom.sendMessage.addEventListener('click', sendMessage);
            dom.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 输入框内容变化
            dom.messageInput.addEventListener('input', () => {
                if (dom.messageInput.value.trim() !== '') {
                    dom.sendMessage.classList.add('active');
                } else {
                    dom.sendMessage.classList.remove('active');
                }
            });

            // 添加角色
            document.getElementById('addContact').addEventListener('click', () => {
                resetRoleForm();
                document.getElementById('addRoleModal').classList.add('active');
                bindRoleEditEvents(); // 绑定角色编辑相关事件
            });

            // 新建聊天
            document.getElementById('newChat').addEventListener('click', () => {
                resetRoleForm();
                document.getElementById('addRoleModal').classList.add('active');
                bindRoleEditEvents(); // 绑定角色编辑相关事件
            });

            // 设置页面各项点击事件
            bindSettingsItemEvents();

            // 模态框关闭
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.remove('active');
                    });
                });
            });

            // 保存角色
            dom.saveRole.addEventListener('click', saveNewRole);

            // 发布动态
            dom.postMoment.addEventListener('click', postNewMoment);

            // API相关事件监听器将在模态框打开时绑定

            // 清除聊天按钮
            bindClearChatBtnEvent();
        }
        
        // 绑定头像编辑事件：每次 openChat 后都重新绑定
        function bindChatHeaderEditEvent() {
            const header = document.querySelector('.chat-header');
            if (!header) return;
            // 先解绑，防止重复绑定
            header.onclick = null;
            header.onclick = function (e) {
                // 避免点击 header 内部按钮（如电话、视频、info）也弹窗
                if (e.target.closest('.chat-header-actions')) return;

                const chat = appState.chats.find(c => c.id === appState.currentChat);
                if (!chat) return;
                const role = appState.roles.find(r => r.id === chat.roleId);
                if (!role) return;
                document.getElementById('roleName').value = role.name;
                document.getElementById('rolePrompt').value = role.prompt;
                document.getElementById('roleAvatar').value = '';
                document.getElementById('saveRole').dataset.editRoleId = role.id;
                document.getElementById('addRoleModal').classList.add('active');
                bindModalCloseEvents(); // 保证弹窗可关闭
                bindRoleEditEvents(); // 绑定角色编辑相关事件
            };
        }

        // 重置角色表单
        function resetRoleForm() {
            // 清空手动创建表单
            document.getElementById('roleName').value = '';
            document.getElementById('rolePrompt').value = '';
            document.getElementById('roleAvatar').value = '';
            document.getElementById('saveRole').dataset.editRoleId = '';

            // 清空JSON导入表单
            document.getElementById('jsonInput').value = '';
            document.getElementById('jsonFile').value = '';
            document.getElementById('jsonPreview').style.display = 'none';

            // 重置到手动创建模式
            document.querySelectorAll('.import-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === 'manual') {
                    tab.classList.add('active');
                }
            });

            document.querySelectorAll('.import-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === 'manual-form') {
                    content.classList.add('active');
                }
            });

            // 清理全局变量
            window.parsedRoleData = null;

            // 隐藏删除按钮（新建模式）
            const deleteBtn = document.getElementById('deleteRole');
            if (deleteBtn) {
                deleteBtn.style.display = 'none';
            }
        }

        // 绑定角色编辑相关事件
        function bindRoleEditEvents() {
            const promptTextarea = document.getElementById('rolePrompt');
            const charCountSpan = document.getElementById('promptCharCount');

            if (promptTextarea && charCountSpan) {
                // 更新字符计数
                function updateCharCount() {
                    const currentLength = promptTextarea.value.length;
                    charCountSpan.textContent = currentLength;

                    // 根据字符数量改变颜色
                    if (currentLength > 900) {
                        charCountSpan.style.color = '#ff4d4f'; // 红色警告
                    } else if (currentLength > 800) {
                        charCountSpan.style.color = '#faad14'; // 橙色提醒
                    } else {
                        charCountSpan.style.color = '#666'; // 默认颜色
                    }
                }

                // 初始化字符计数
                updateCharCount();

                // 绑定输入事件
                promptTextarea.oninput = updateCharCount;
                promptTextarea.onpaste = function() {
                    // 粘贴后稍微延迟更新，确保内容已经粘贴完成
                    setTimeout(updateCharCount, 10);
                };
            }

            // 绑定导入方式切换
            bindImportTabEvents();

            // 绑定JSON解析功能
            bindJsonParseEvents();

            // 绑定删除按钮事件
            bindDeleteRoleEvents();
        }

        // 绑定导入方式切换事件
        function bindImportTabEvents() {
            const importTabs = document.querySelectorAll('.import-tab');
            const importContents = document.querySelectorAll('.import-content');

            importTabs.forEach(tab => {
                tab.onclick = function() {
                    const targetTab = this.dataset.tab;

                    // 切换标签页状态
                    importTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // 切换内容显示
                    importContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetTab + '-form') {
                            content.classList.add('active');
                        }
                    });
                };
            });
        }

        // 绑定JSON解析事件
        function bindJsonParseEvents() {
            const parseJsonBtn = document.getElementById('parseJson');
            const clearJsonBtn = document.getElementById('clearJson');
            const jsonInput = document.getElementById('jsonInput');
            const jsonFile = document.getElementById('jsonFile');
            const jsonPreview = document.getElementById('jsonPreview');
            const previewContent = document.getElementById('previewContent');

            if (parseJsonBtn && jsonInput && jsonPreview && previewContent) {
                // 文件上传处理
                if (jsonFile) {
                    jsonFile.onchange = function(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        // 验证文件类型
                        if (!file.name.toLowerCase().endsWith('.json')) {
                            alert('请选择JSON格式的文件');
                            jsonFile.value = '';
                            return;
                        }

                        // 读取文件内容
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const jsonText = e.target.result;

                                // 验证文件内容不为空
                                if (!jsonText || jsonText.trim() === '') {
                                    throw new Error('文件内容为空');
                                }

                                jsonInput.value = jsonText; // 同步到文本框

                                // 自动解析
                                const jsonData = JSON.parse(jsonText);

                                // 验证JSON数据
                                if (!jsonData || typeof jsonData !== 'object') {
                                    throw new Error('JSON数据格式无效');
                                }

                                const parsedRole = parseJsonToRole(jsonData);
                                displayJsonPreview(parsedRole, previewContent);
                                jsonPreview.style.display = 'block';
                            } catch (error) {
                                console.error('JSON解析错误:', error);
                                alert('JSON文件格式错误：' + error.message);
                                jsonFile.value = '';
                                jsonInput.value = '';
                                jsonPreview.style.display = 'none';
                            }
                        };

                        reader.onerror = function() {
                            alert('文件读取失败，请重试');
                            jsonFile.value = '';
                        };

                        reader.readAsText(file, 'UTF-8');
                    };
                }

                // 手动解析按钮
                parseJsonBtn.onclick = function() {
                    const jsonText = jsonInput.value.trim();
                    if (!jsonText) {
                        alert('请上传JSON文件或输入JSON数据');
                        return;
                    }

                    try {
                        const jsonData = JSON.parse(jsonText);
                        const parsedRole = parseJsonToRole(jsonData);
                        displayJsonPreview(parsedRole, previewContent);
                        jsonPreview.style.display = 'block';
                    } catch (error) {
                        alert('JSON格式错误：' + error.message);
                        jsonPreview.style.display = 'none';
                    }
                };

                // 清空按钮
                if (clearJsonBtn) {
                    clearJsonBtn.onclick = function() {
                        jsonInput.value = '';
                        jsonFile.value = '';
                        jsonPreview.style.display = 'none';
                        window.parsedRoleData = null;
                    };
                }
            }
        }

        // 绑定删除角色事件
        function bindDeleteRoleEvents() {
            const deleteBtn = document.getElementById('deleteRole');
            const confirmDeleteBtn = document.getElementById('confirmDeleteRole');
            const deleteModal = document.getElementById('deleteRoleModal');
            const deleteRoleName = document.getElementById('deleteRoleName');

            if (deleteBtn && confirmDeleteBtn && deleteModal && deleteRoleName) {
                // 检查是否是编辑模式（有roleId）
                const roleId = document.getElementById('saveRole').dataset.editRoleId;
                if (roleId) {
                    // 编辑模式，显示删除按钮
                    deleteBtn.style.display = 'block';

                    // 获取角色信息
                    const role = appState.roles.find(r => r.id === roleId);
                    if (role) {
                        deleteRoleName.textContent = role.name;
                    }
                } else {
                    // 新建模式，隐藏删除按钮
                    deleteBtn.style.display = 'none';
                }

                // 删除按钮点击事件
                deleteBtn.onclick = function() {
                    deleteModal.classList.add('active');
                };

                // 确认删除按钮点击事件
                confirmDeleteBtn.onclick = function() {
                    deleteRoleAndChats(roleId);
                    deleteModal.classList.remove('active');
                    document.getElementById('addRoleModal').classList.remove('active');
                };
            }
        }

        // 删除角色和相关聊天记录
        function deleteRoleAndChats(roleId) {
            if (!roleId) return;

            // 找到要删除的角色
            const roleIndex = appState.roles.findIndex(r => r.id === roleId);
            if (roleIndex === -1) return;

            const role = appState.roles[roleIndex];

            // 找到所有相关的聊天记录
            const relatedChats = appState.chats.filter(c => c.roleId === roleId);
            const isCurrentChatDeleted = relatedChats.some(c => c.id === appState.currentChat);

            // 删除角色
            appState.roles.splice(roleIndex, 1);

            // 删除相关聊天记录
            appState.chats = appState.chats.filter(c => c.roleId !== roleId);

            // 如果删除的是当前聊天，需要处理界面状态
            if (isCurrentChatDeleted) {
                appState.currentChat = null;

                // 如果还有其他聊天，打开第一个
                if (appState.chats.length > 0) {
                    openChat(appState.chats[0].id);
                } else {
                    // 没有聊天了，显示聊天列表
                    switchView('chats');
                    document.querySelector('.chat-container').style.display = 'none';
                }
            }

            // 保存数据并更新界面
            saveData();
            renderChatList();

            // 显示删除成功提示
            alert(`角色"${role.name}"及其相关聊天记录已删除`);
        }

        // 安全的数组转换函数
        function safeArrayConvert(value) {
            if (value === null || value === undefined) return [];
            if (Array.isArray(value)) return value;
            if (typeof value === 'string') return [value];
            if (typeof value === 'number') return [value.toString()];
            return [String(value)];
        }

        // JSON角色预设解析器
        function parseJsonToRole(jsonData) {
            try {
                // 验证输入数据
                if (!jsonData || typeof jsonData !== 'object') {
                    throw new Error('无效的JSON数据');
                }

                const role = {
                    id: `role-${Date.now()}`,
                    name: '',
                    avatar: '',
                    prompt: '',
                    // 扩展字段支持复杂角色信息
                    personality: '',
                    background: '',
                    traits: [],
                    skills: [],
                    relationships: {},
                    memories: [],
                    goals: [],
                    fears: [],
                    likes: [],
                    dislikes: [],
                    speaking_style: '',
                    appearance: '',
                    age: '',
                    occupation: '',
                    location: '',
                    extra_info: {}
                };

                // 基础字段映射
                if (jsonData.name) role.name = jsonData.name;
                if (jsonData.avatar) role.avatar = jsonData.avatar;
                if (jsonData.prompt) role.prompt = jsonData.prompt;

                // 扩展字段映射
                if (jsonData.personality) role.personality = String(jsonData.personality);
                if (jsonData.background) role.background = String(jsonData.background);
                if (jsonData.traits) role.traits = safeArrayConvert(jsonData.traits);
                if (jsonData.skills) role.skills = safeArrayConvert(jsonData.skills);
                if (jsonData.relationships && typeof jsonData.relationships === 'object') {
                    role.relationships = jsonData.relationships;
                }
                if (jsonData.memories) role.memories = safeArrayConvert(jsonData.memories);
                if (jsonData.goals) role.goals = safeArrayConvert(jsonData.goals);
                if (jsonData.fears) role.fears = safeArrayConvert(jsonData.fears);
                if (jsonData.likes) role.likes = safeArrayConvert(jsonData.likes);
                if (jsonData.dislikes) role.dislikes = safeArrayConvert(jsonData.dislikes);
                if (jsonData.speaking_style || jsonData.speakingStyle) role.speaking_style = jsonData.speaking_style || jsonData.speakingStyle;
                if (jsonData.appearance) role.appearance = jsonData.appearance;
                if (jsonData.age) role.age = jsonData.age;
                if (jsonData.occupation) role.occupation = jsonData.occupation;
                if (jsonData.location) role.location = jsonData.location;

                // 处理其他未知字段
                Object.keys(jsonData).forEach(key => {
                    if (!['name', 'avatar', 'prompt', 'personality', 'background', 'traits', 'skills',
                          'relationships', 'memories', 'goals', 'fears', 'likes', 'dislikes',
                          'speaking_style', 'speakingStyle', 'appearance', 'age', 'occupation', 'location'].includes(key)) {
                        role.extra_info[key] = jsonData[key];
                    }
                });

                // 如果没有基础prompt，尝试从其他字段生成
                if (!role.prompt && (role.personality || role.background)) {
                    role.prompt = generatePromptFromFields(role);
                }

                // 设置默认头像
                if (!role.avatar && role.name) {
                    role.avatar = role.name.charAt(0);
                }

                return role;
            } catch (error) {
                console.error('角色数据解析错误:', error);
                throw new Error('角色数据解析失败: ' + error.message);
            }
        }

        // 从扩展字段生成prompt
        function generatePromptFromFields(role) {
            let prompt = '';

            if (role.name) {
                prompt += `我是${role.name}。`;
            }

            if (role.personality) {
                prompt += `性格特点：${role.personality}。`;
            }

            if (role.background) {
                prompt += `背景：${role.background}。`;
            }

            if (role.occupation) {
                prompt += `职业：${role.occupation}。`;
            }

            if (role.traits && role.traits.length > 0) {
                prompt += `特征：${role.traits.join('、')}。`;
            }

            if (role.speaking_style) {
                prompt += `说话风格：${role.speaking_style}。`;
            }

            return prompt;
        }

        // HTML转义函数
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // 显示JSON解析预览
        function displayJsonPreview(role, container) {
            let html = '';

            // 基础信息
            if (role.name) {
                html += `<div class="preview-item">
                    <div class="preview-label">角色名称</div>
                    <div class="preview-value">${escapeHtml(role.name)}</div>
                </div>`;
            }

            if (role.prompt) {
                html += `<div class="preview-item">
                    <div class="preview-label">角色描述</div>
                    <div class="preview-value">${escapeHtml(role.prompt)}</div>
                </div>`;
            }

            // 扩展信息
            if (role.personality) {
                html += `<div class="preview-item">
                    <div class="preview-label">性格特点</div>
                    <div class="preview-value">${escapeHtml(role.personality)}</div>
                </div>`;
            }

            if (role.background) {
                html += `<div class="preview-item">
                    <div class="preview-label">背景故事</div>
                    <div class="preview-value">${escapeHtml(role.background)}</div>
                </div>`;
            }

            if (role.traits && role.traits.length > 0) {
                html += `<div class="preview-item">
                    <div class="preview-label">特征标签</div>
                    <div class="preview-value">${escapeHtml(role.traits.join('、'))}</div>
                </div>`;
            }

            if (role.speaking_style) {
                html += `<div class="preview-item">
                    <div class="preview-label">说话风格</div>
                    <div class="preview-value">${escapeHtml(role.speaking_style)}</div>
                </div>`;
            }

            // 其他信息
            if (Object.keys(role.extra_info).length > 0) {
                html += `<div class="preview-item">
                    <div class="preview-label">其他信息</div>
                    <div class="preview-value">${escapeHtml(JSON.stringify(role.extra_info, null, 2))}</div>
                </div>`;
            }

            container.innerHTML = html;

            // 将解析结果存储到全局变量，供保存时使用
            window.parsedRoleData = role;
        }

        // 绑定设置项点击事件（每次切换到设置页面都重新绑定）
        function bindSettingsItemEvents() {
            document.querySelectorAll('.settings-item').forEach(item => {
                item.onclick = null; // 先解绑
                const name = item.querySelector('.settings-name')?.textContent?.trim();
                if (name === 'API配置') {
                    item.onclick = function() {
                        loadApiConfigToModal();
                        document.getElementById('apiConfigModal').classList.add('active');
                        bindModalCloseEvents(); // 保证弹窗可关闭
                    };
                } else if (name === '用户信息') {
                    item.onclick = function() {
                        loadUserInfoToModal();
                        document.getElementById('userInfoModal').classList.add('active');
                        bindModalCloseEvents(); // 保证弹窗可关闭
                    };
                } else if (name === '全局预设') {
                    item.onclick = function() {
                        loadGlobalPresetToModal();
                        document.getElementById('globalPresetModal').classList.add('active');
                        bindModalCloseEvents(); // 保证弹窗可关闭
                    };
                } else if (name === '角色管理') {
                    // item.onclick = openRoleManageModal;
                }
                // 其他设置项...
            });
        }

        // 保证每次弹窗关闭都能生效
        function bindModalCloseEvents() {
            document.querySelectorAll('.modal-close, .btn.btn-secondary.modal-close').forEach(btn => {
                btn.onclick = function () {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.remove('active');
                    });
                };
            });
        }

        // 替换 sendMessage 和 generateAIResponse，加入真实API调用（以 DeepSeek/OpenAI 为例）

        async function sendMessage() {
            const message = dom.messageInput.value.trim();
            if (message === '' || !appState.currentChat) return;

            // 获取当前聊天
            const chat = appState.chats.find(c => c.id === appState.currentChat);
            if (!chat) return;

            // 添加用户消息
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            const userMessage = {
                id: `msg-${Date.now()}`,
                sender: 'user',
                content: message,
                time: timeStr
            };

            chat.messages.push(userMessage);

            // 更新UI
            renderMessages(chat.messages);
            dom.messageInput.value = '';
            dom.sendMessage.classList.remove('active');

            // 显示打字指示器
            showTypingIndicator && showTypingIndicator();

            // 真实API调用
            try {
                const aiContent = await generateAIResponse(message, chat.roleId, chat.messages);
                // 移除打字指示器
                hideTypingIndicator && hideTypingIndicator();

                const aiMessage = {
                    id: `msg-${Date.now()}`,
                    sender: 'ai',
                    content: aiContent,
                    time: `${now.getHours()}:${(now.getMinutes() + 1).toString().padStart(2, '0')}`
                };

                chat.messages.push(aiMessage);
                renderMessages(chat.messages);

                // 更新聊天列表信息（AI回复）
                chat.lastMessage = aiMessage.content.length > 30 ?
                    aiMessage.content.substring(0, 30) + '...' : aiMessage.content;
                chat.lastTime = '刚刚';
                chat.lastUpdateTime = Date.now();

                saveData();
                renderChatList();
            } catch (err) {
                hideTypingIndicator && hideTypingIndicator();
                const aiMessage = {
                    id: `msg-${Date.now()}`,
                    sender: 'ai',
                    content: 'AI回复失败，请检查API配置。',
                    time: `${now.getHours()}:${(now.getMinutes() + 1).toString().padStart(2, '0')}`
                };
                chat.messages.push(aiMessage);
                renderMessages(chat.messages);

                // 更新聊天列表信息（错误回复）
                chat.lastMessage = 'AI回复失败，请检查API配置。';
                chat.lastTime = '刚刚';
                chat.lastUpdateTime = Date.now();

                saveData();
                renderChatList();
            }

            // 将当前聊天移动到列表顶部
            moveToTop(chat.id);
        }

        // 真实AI回复（支持多个API提供商）
        async function generateAIResponse(message, roleId, messages) {
            const config = appState.apiConfig;
            const role = appState.roles.find(r => r.id === roleId);
            const user = appState.user;

            // 构造上下文
            const contextMessages = messages
                .slice(-config.contextLength * 2) // 取最近N轮
                .map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: msg.content
                }));

            // 计算当前轮次（基于消息总数）
            const currentRound = Math.floor(messages.length / 2) + 1; // 每2条消息算1轮对话
            const isFirstRound = currentRound === 1; // 是否为首次对话

            // 判断是否需要发送角色资料（第1，4，7，10...轮，即每3轮发送一次）
            const shouldSendRoleInfo = (currentRound - 1) % 3 === 0;

            // 判断是否需要发送用户资料（从第2轮开始，每4轮发送一次：第2，6，10，14...轮）
            const shouldSendUserInfo = currentRound >= 2 && (currentRound - 2) % 4 === 0;

            // 构造系统提示词
            let systemPrompt = '';

            if (shouldSendRoleInfo) {
                systemPrompt += buildCompleteRolePrompt(role);
            } else {
                systemPrompt += `你是${role.name}。`;
            }

            if (shouldSendUserInfo) {
                systemPrompt += `

用户信息：
- 姓名：${user.name}
- 简介：${user.bio || '暂无简介'}`;
            }

            // 首次对话时添加全局预设
            if (isFirstRound) {
                const globalPreset = appState.globalPreset;

                if (globalPreset.dialogStyle.enabled && globalPreset.dialogStyle.prompt) {
                    systemPrompt += `

对话风格要求：
${globalPreset.dialogStyle.prompt}`;
                }

                if (globalPreset.statusBar.enabled && globalPreset.statusBar.prompt) {
                    systemPrompt += `

状态显示要求：
${globalPreset.statusBar.prompt}`;
                }
            }

            systemPrompt += `

请根据角色设定与用户进行对话，可以适当称呼用户的姓名。`;

            // 调试信息（可选，用于验证发送策略）
            console.log(`第${currentRound}轮对话 - 发送角色资料: ${shouldSendRoleInfo}, 发送用户资料: ${shouldSendUserInfo}, 首次对话: ${isFirstRound}`);

            let requestConfig;
            let url = config.endpoint;

            switch (config.provider) {
                case 'openai':
                case 'deepseek':
                case 'moonshot':
                    // OpenAI兼容格式
                    contextMessages.unshift({
                        role: 'system',
                        content: systemPrompt
                    });

                    requestConfig = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: contextMessages,
                            temperature: config.temperature,
                            max_tokens: 2000
                        })
                    };
                    break;

                case 'claude':
                    // Claude格式
                    const claudeMessages = contextMessages.filter(msg => msg.role !== 'system');

                    requestConfig = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': config.apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: config.model,
                            max_tokens: 2000,
                            system: systemPrompt,
                            messages: claudeMessages,
                            temperature: config.temperature
                        })
                    };
                    break;

                case 'gemini':
                    // Gemini格式
                    const geminiUrl = config.endpoint.replace('{model}', config.model) + `?key=${config.apiKey}`;

                    // 转换消息格式
                    const geminiContents = contextMessages
                        .filter(msg => msg.role !== 'system')
                        .map(msg => ({
                            role: msg.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: msg.content }]
                        }));

                    requestConfig = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            system_instruction: {
                                parts: [{ text: systemPrompt }]
                            },
                            contents: geminiContents,
                            generationConfig: {
                                temperature: config.temperature,
                                maxOutputTokens: 2000
                            }
                        })
                    };
                    url = geminiUrl;
                    break;

                default:
                    // 默认使用OpenAI格式
                    contextMessages.unshift({
                        role: 'system',
                        content: systemPrompt
                    });

                    requestConfig = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: config.model,
                            messages: contextMessages,
                            temperature: config.temperature,
                            max_tokens: 2000
                        })
                    };
            }

            // 发起请求
            const resp = await fetch(url, requestConfig);

            if (!resp.ok) {
                const errorText = await resp.text();
                console.error('API请求失败:', errorText);
                throw new Error(`API请求失败: ${resp.status} ${resp.statusText}`);
            }

            const data = await resp.json();

            // 根据不同提供商解析响应
            switch (config.provider) {
                case 'openai':
                case 'deepseek':
                case 'moonshot':
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        return data.choices[0].message.content.trim();
                    }
                    break;

                case 'claude':
                    if (data.content && data.content[0] && data.content[0].text) {
                        return data.content[0].text.trim();
                    }
                    break;

                case 'gemini':
                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                        return data.candidates[0].content.parts[0].text.trim();
                    }
                    break;

                default:
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        return data.choices[0].message.content.trim();
                    } else if (data.choices && data.choices[0] && data.choices[0].text) {
                        return data.choices[0].text.trim();
                    }
            }

            console.error('无法解析AI响应:', data);
            throw new Error('AI回复解析失败');
        }

        // 打字指示器（如有）
        function showTypingIndicator() {
            // 获取当前聊天的角色信息
            const chat = appState.chats.find(c => c.id === appState.currentChat);
            if (!chat) return;

            const role = appState.roles.find(r => r.id === chat.roleId);
            if (!role) return;

            // 构造角色头像HTML
            let avatarHtml = '';
            if (role.avatar && role.avatar.startsWith('data:image')) {
                avatarHtml = `<img src="${role.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />`;
            } else {
                avatarHtml = role.avatar || '🤖';
            }

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message-row typing-message';
            typingIndicator.innerHTML = `
                <div class="message-avatar">${avatarHtml}</div>
                <div class="message-bubble">
                    <div class="message-content">
                        <span class="typing-indicator">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </div>
                </div>
            `;
            dom.chatMessages.appendChild(typingIndicator);
            dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
        }
        function hideTypingIndicator() {
            const typing = dom.chatMessages.querySelector('.typing-indicator');
            if (typing) typing.closest('.message-row').remove();
        }
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM加载完成，开始初始化...');
            try {
                initApp();
                // 不需要在这里绑定头像和设置事件，initApp会自动调用
                bindModalCloseEvents();
                console.log('初始化完成');
            } catch (error) {
                console.error('初始化失败:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });

        function saveNewRole() {
            const roleId = dom.saveRole.dataset.editRoleId;

            // 检查是否是JSON导入模式
            const activeTab = document.querySelector('.import-tab.active');
            const isJsonMode = activeTab && activeTab.dataset.tab === 'json';

            let roleData;

            if (isJsonMode && window.parsedRoleData) {
                // JSON导入模式
                roleData = window.parsedRoleData;

                // 验证必要字段
                if (!roleData.name) {
                    alert('JSON数据中缺少角色名称');
                    return;
                }
            } else {
                // 手动创建模式
                const name = document.getElementById('roleName').value.trim();
                const prompt = document.getElementById('rolePrompt').value.trim();

                if (!name || !prompt) {
                    alert('请填写角色名称和描述');
                    return;
                }

                roleData = {
                    id: roleId || `role-${Date.now()}`,
                    name: name,
                    prompt: prompt,
                    avatar: null // 先设为null，后面统一处理头像
                };
            }

            // 处理头像
            const avatarInput = document.getElementById('roleAvatar');

            if (roleId) {
                // 编辑现有角色
                const role = appState.roles.find(r => r.id === roleId);
                if (!role) return;

                updateExistingRole(role, roleData, avatarInput);
            } else {
                // 创建新角色
                createNewRole(roleData, avatarInput);
            }
        }

        // 更新现有角色
        function updateExistingRole(role, roleData, avatarInput) {
            // 头像处理（如有新上传则用新头像，否则保持原头像）
            if (avatarInput.files && avatarInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    roleData.avatar = e.target.result;
                    updateRoleAndClose();
                };
                reader.readAsDataURL(avatarInput.files[0]);
            } else {
                // 没有新头像，保持原有头像或设置默认头像
                if (!roleData.avatar || roleData.avatar === null) {
                    roleData.avatar = role.avatar || roleData.name.charAt(0).toUpperCase();
                }
                updateRoleAndClose();
            }

            function updateRoleAndClose() {
                // 更新角色数据（包括扩展字段）
                Object.assign(role, roleData);

                // 同步更新聊天列表中的角色名称
                const relatedChats = appState.chats.filter(c => c.roleId === role.id);
                relatedChats.forEach(chat => {
                    chat.name = roleData.name; // 更新聊天列表中显示的名称
                });

                saveData();
                renderChatList();

                // 关闭弹窗
                dom.addRoleModal.classList.remove('active');

                // 如果当前聊天用的是这个角色，刷新聊天头部和名称
                if (appState.currentChat) {
                    const chat = appState.chats.find(c => c.id === appState.currentChat);
                    if (chat && chat.roleId === role.id) {
                        // 更新聊天头部名称
                        document.querySelector('.chat-header-name').textContent = roleData.name;
                        // 重新渲染整个聊天界面以确保所有地方都更新
                        openChat(chat.id);
                    }
                }
            }
        }

        // 创建新角色
        function createNewRole(roleData, avatarInput) {
            // 头像处理
            if (avatarInput.files && avatarInput.files[0]) {
                // 有上传的头像文件
                const reader = new FileReader();
                reader.onload = function(e) {
                    roleData.avatar = e.target.result;
                    createRoleAndChat();
                };
                reader.readAsDataURL(avatarInput.files[0]);
            } else {
                // 没有上传头像文件，设置默认头像
                if (!roleData.avatar || roleData.avatar === null) {
                    roleData.avatar = roleData.name.charAt(0).toUpperCase();
                }
                createRoleAndChat();
            }

            function createRoleAndChat() {
                // 添加角色到状态
                appState.roles.push(roleData);

                // 创建新聊天
                const newChat = {
                    id: `chat-${Date.now()}`,
                    roleId: roleData.id,
                    name: roleData.name,
                    lastMessage: '开始聊天吧！',
                    lastTime: '刚刚',
                    lastUpdateTime: Date.now(), // 添加时间戳用于排序
                    unread: 0,
                    messages: [
                        {
                            id: `msg-${Date.now()}`,
                            sender: 'ai',
                            content: generateWelcomeMessage(roleData),
                            time: '刚刚'
                        }
                    ]
                };

                appState.chats.push(newChat);

                saveData();
                renderChatList();

                // 关闭弹窗
                dom.addRoleModal.classList.remove('active');

                // 清理JSON解析数据
                window.parsedRoleData = null;

                // 自动打开新创建的聊天
                openChat(newChat.id);
            }
        }

        // 生成欢迎消息
        function generateWelcomeMessage(roleData) {
            let message = `你好！我是${roleData.name}。`;

            if (roleData.personality) {
                message += `我的性格特点是${roleData.personality}。`;
            }

            if (roleData.occupation) {
                message += `我的职业是${roleData.occupation}。`;
            }

            message += '很高兴认识你，我们开始聊天吧！';

            return message;
        }

        // 构建完整的角色提示词（支持复杂角色数据）
        function buildCompleteRolePrompt(role) {
            let prompt = `你是${role.name}。`;

            // 基础描述
            if (role.prompt) {
                prompt += `${role.prompt}`;
            }

            // 性格特点
            if (role.personality) {
                prompt += `\n\n性格特点：${role.personality}`;
            }

            // 背景故事
            if (role.background) {
                prompt += `\n\n背景故事：${role.background}`;
            }

            // 职业信息
            if (role.occupation) {
                prompt += `\n\n职业：${role.occupation}`;
            }

            // 年龄信息
            if (role.age) {
                prompt += `\n\n年龄：${role.age}`;
            }

            // 外貌描述
            if (role.appearance) {
                prompt += `\n\n外貌：${role.appearance}`;
            }

            // 特征标签
            if (role.traits && role.traits.length > 0) {
                prompt += `\n\n特征：${role.traits.join('、')}`;
            }

            // 技能
            if (role.skills && role.skills.length > 0) {
                prompt += `\n\n技能：${role.skills.join('、')}`;
            }

            // 喜好
            if (role.likes && role.likes.length > 0) {
                prompt += `\n\n喜欢：${role.likes.join('、')}`;
            }

            // 厌恶
            if (role.dislikes && role.dislikes.length > 0) {
                prompt += `\n\n不喜欢：${role.dislikes.join('、')}`;
            }

            // 恐惧
            if (role.fears && role.fears.length > 0) {
                prompt += `\n\n害怕：${role.fears.join('、')}`;
            }

            // 目标
            if (role.goals && role.goals.length > 0) {
                prompt += `\n\n目标：${role.goals.join('、')}`;
            }

            // 说话风格
            if (role.speaking_style) {
                prompt += `\n\n说话风格：${role.speaking_style}`;
            }

            // 人际关系
            if (role.relationships && Object.keys(role.relationships).length > 0) {
                prompt += `\n\n人际关系：`;
                Object.entries(role.relationships).forEach(([person, relation]) => {
                    prompt += `\n- ${person}：${relation}`;
                });
            }

            // 记忆
            if (role.memories && role.memories.length > 0) {
                prompt += `\n\n重要记忆：${role.memories.join('；')}`;
            }

            // 位置信息
            if (role.location) {
                prompt += `\n\n所在地：${role.location}`;
            }

            // 其他扩展信息
            if (role.extra_info && Object.keys(role.extra_info).length > 0) {
                prompt += `\n\n其他信息：`;
                Object.entries(role.extra_info).forEach(([key, value]) => {
                    if (typeof value === 'string' || typeof value === 'number') {
                        prompt += `\n- ${key}：${value}`;
                    } else if (Array.isArray(value)) {
                        prompt += `\n- ${key}：${value.join('、')}`;
                    } else if (typeof value === 'object') {
                        prompt += `\n- ${key}：${JSON.stringify(value)}`;
                    }
                });
            }

            return prompt;
        }

        // 清除当前聊天记录
        function clearCurrentChatHistory() {
            if (!appState.currentChat) return;
            const chat = appState.chats.find(c => c.id === appState.currentChat);
            if (!chat) return;
            chat.messages = [];
            chat.lastMessage = '';
            chat.lastTime = '';
            saveData();
            renderMessages(chat.messages);
            renderChatList();
        }

        function bindClearChatBtnEvent() {
            const clearBtn = document.getElementById('clearChatBtn');
            if (clearBtn) {
                clearBtn.onclick = function() {
                    if (confirm('确认清除当前全部对话内容？')) {
                        clearCurrentChatHistory();
                    }
                };
            }
        }

        // API配置相关函数
        function updateApiConfigFields() {
            const provider = document.getElementById('apiProvider').value;
            const endpointInput = document.getElementById('apiEndpoint');
            const endpointHelp = document.getElementById('endpointHelp');
            const modelSelect = document.getElementById('aiModel');
            const modelHelp = document.getElementById('modelHelp');
            const apiKeyHelp = document.getElementById('apiKeyHelp');

            // 更新端点
            if (apiEndpoints[provider]) {
                endpointInput.value = apiEndpoints[provider].endpoint;
                endpointHelp.textContent = apiEndpoints[provider].help;
            }

            // 更新模型列表
            modelSelect.innerHTML = '';
            if (apiModels[provider]) {
                apiModels[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    if (model.tag) {
                        const tagClass = model.tag === 'recommended' ? 'model-recommended' :
                                       model.tag === 'popular' ? 'model-popular' : 'model-latest';
                        option.textContent += ` [${model.tag === 'recommended' ? '推荐' :
                                                   model.tag === 'popular' ? '热门' : '最新'}]`;
                    }
                    modelSelect.appendChild(option);
                });

                // 设置默认选择第一个推荐模型
                const recommendedModel = apiModels[provider].find(m => m.tag === 'recommended');
                if (recommendedModel) {
                    modelSelect.value = recommendedModel.id;
                }
            }

            // 更新帮助文本
            updateModelHelp();
            updateApiKeyHelp(provider);
        }

        function updateModelHelp() {
            const provider = document.getElementById('apiProvider').value;
            const modelId = document.getElementById('aiModel').value;
            const modelHelp = document.getElementById('modelHelp');

            if (apiModels[provider]) {
                const model = apiModels[provider].find(m => m.id === modelId);
                if (model && model.desc) {
                    modelHelp.textContent = model.desc;
                } else {
                    modelHelp.textContent = '请选择适合您需求的模型';
                }
            }
        }

        function updateApiKeyHelp(provider) {
            const apiKeyHelp = document.getElementById('apiKeyHelp');
            const helpTexts = {
                openai: '请输入您的OpenAI API Key，格式：sk-...',
                claude: '请输入您的Anthropic API Key',
                gemini: '请输入您的Google API Key',
                deepseek: '请输入您的DeepSeek API Key',
                zhipu: '请输入您的智谱AI API Key',
                moonshot: '请输入您的月之暗面API Key',
                yi: '请输入您的零一万物API Key',
                baidu: '请输入您的百度API Key或Access Token',
                alibaba: '请输入您的阿里云API Key',
                tencent: '请输入您的腾讯云API Key',
                xunfei: '请输入您的讯飞API Key',
                minimax: '请输入您的MiniMax API Key',
                custom: '请输入您的自定义API Key'
            };
            apiKeyHelp.textContent = helpTexts[provider] || '请输入API密钥';
        }

        function saveApiConfig() {
            const config = {
                provider: document.getElementById('apiProvider').value,
                apiKey: document.getElementById('apiKey').value,
                endpoint: document.getElementById('apiEndpoint').value,
                model: document.getElementById('aiModel').value,
                contextLength: parseInt(document.getElementById('contextLength').value),
                responseDelay: parseInt(document.getElementById('responseDelay').value),
                temperature: parseFloat(document.getElementById('temperature').value)
            };

            // 验证必填字段
            if (!config.apiKey.trim()) {
                alert('请输入API密钥');
                return;
            }
            if (!config.endpoint.trim()) {
                alert('请输入API端点');
                return;
            }

            // 保存配置
            appState.apiConfig = config;
            saveData();

            // 关闭模态框
            document.getElementById('apiConfigModal').classList.remove('active');
            alert('API配置已保存');
        }

        async function testApiConnection() {
            const config = {
                provider: document.getElementById('apiProvider').value,
                apiKey: document.getElementById('apiKey').value.trim(),
                endpoint: document.getElementById('apiEndpoint').value.trim(),
                model: document.getElementById('aiModel').value
            };

            if (!config.apiKey) {
                alert('请先输入API密钥');
                return;
            }
            if (!config.endpoint) {
                alert('请先输入API端点');
                return;
            }

            // 显示测试中状态
            const testBtn = document.getElementById('testApiConnection');
            const originalText = testBtn.textContent;
            testBtn.textContent = '测试中...';
            testBtn.disabled = true;

            try {
                // 首先验证API Key格式
                const keyValidation = validateApiKey(config.provider, config.apiKey);
                if (!keyValidation.valid) {
                    throw new Error(`API密钥格式错误: ${keyValidation.message}`);
                }

                // 发送测试请求
                const result = await sendTestRequest(config);

                testBtn.textContent = originalText;
                testBtn.disabled = false;

                if (result.success) {
                    alert(`✅ API连接测试成功！\n\n响应信息：${result.message}`);
                } else {
                    alert(`❌ API连接测试失败：\n\n${result.error}`);
                }
            } catch (error) {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
                alert(`❌ 测试失败：\n\n${error.message}`);
            }
        }

        function validateApiKey(provider, apiKey) {
            const validations = {
                openai: {
                    pattern: /^sk-[a-zA-Z0-9\-_]{20,}$/,
                    message: 'OpenAI API Key应以"sk-"开头'
                },
                claude: {
                    pattern: /^sk-ant-[a-zA-Z0-9\-_]{50,}$/,
                    message: 'Claude API Key应以"sk-ant-"开头'
                },
                gemini: {
                    pattern: /^[a-zA-Z0-9\-_]{20,}$/,
                    message: 'Gemini API Key应为20位以上字符'
                },
                deepseek: {
                    pattern: /^sk-[a-zA-Z0-9\-_]{20,}$/,
                    message: 'DeepSeek API Key应以"sk-"开头，后跟20位以上字符'
                },
                zhipu: {
                    pattern: /^[a-zA-Z0-9]{20,}\.[a-zA-Z0-9]{6,}$/,
                    message: '智谱AI API Key格式：数字字母.数字字母'
                },
                moonshot: {
                    pattern: /^sk-[a-zA-Z0-9\-_]{20,}$/,
                    message: 'Moonshot API Key应以"sk-"开头'
                },
                yi: {
                    pattern: /^[a-zA-Z0-9\-_]{20,}$/,
                    message: 'Yi API Key应为20位以上字符'
                },
                baidu: {
                    pattern: /^[a-zA-Z0-9\-_]{20,}$/,
                    message: '百度API Key应为20位以上字符'
                },
                alibaba: {
                    pattern: /^sk-[a-zA-Z0-9\-_]{20,}$/,
                    message: '阿里API Key应以"sk-"开头'
                },
                tencent: {
                    pattern: /^[a-zA-Z0-9\-_]{20,}$/,
                    message: '腾讯API Key应为20位以上字符'
                },
                xunfei: {
                    pattern: /^[a-zA-Z0-9\-_]{20,}$/,
                    message: '讯飞API Key应为20位以上字符'
                },
                minimax: {
                    pattern: /^[a-zA-Z0-9\-_]{20,}$/,
                    message: 'MiniMax API Key应为20位以上字符'
                }
            };

            const validation = validations[provider];
            if (!validation) {
                return { valid: true, message: '未知提供商，跳过格式验证' };
            }

            const isValid = validation.pattern.test(apiKey);
            return {
                valid: isValid,
                message: isValid ? '格式正确' : validation.message
            };
        }

        async function sendTestRequest(config) {
            const testMessage = "Hello, this is a test message.";

            try {
                let requestConfig;

                switch (config.provider) {
                    case 'openai':
                    case 'deepseek':
                    case 'moonshot':
                        requestConfig = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${config.apiKey}`
                            },
                            body: JSON.stringify({
                                model: config.model,
                                messages: [{ role: 'user', content: testMessage }],
                                max_tokens: 10
                            })
                        };
                        break;

                    case 'claude':
                        requestConfig = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': config.apiKey,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: config.model,
                                max_tokens: 10,
                                messages: [{ role: 'user', content: testMessage }]
                            })
                        };
                        break;

                    case 'gemini':
                        const geminiEndpoint = config.endpoint.replace('{model}', config.model) + `?key=${config.apiKey}`;
                        requestConfig = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: testMessage }]
                                }],
                                generationConfig: {
                                    maxOutputTokens: 10
                                }
                            })
                        };
                        config.endpoint = geminiEndpoint;
                        break;

                    default:
                        // 对于其他提供商，使用通用格式
                        requestConfig = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${config.apiKey}`
                            },
                            body: JSON.stringify({
                                model: config.model,
                                messages: [{ role: 'user', content: testMessage }],
                                max_tokens: 10
                            })
                        };
                }

                const response = await fetch(config.endpoint, requestConfig);

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error?.message || errorJson.message || errorText;
                    } catch {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                // 解析响应内容
                let responseContent = '';
                switch (config.provider) {
                    case 'openai':
                    case 'deepseek':
                    case 'moonshot':
                        responseContent = data.choices?.[0]?.message?.content || '收到响应';
                        break;
                    case 'claude':
                        responseContent = data.content?.[0]?.text || '收到响应';
                        break;
                    case 'gemini':
                        responseContent = data.candidates?.[0]?.content?.parts?.[0]?.text || '收到响应';
                        break;
                    default:
                        responseContent = '收到响应';
                }

                return {
                    success: true,
                    message: `模型响应: "${responseContent}"`
                };

            } catch (error) {
                // 检查是否是CORS错误
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    return {
                        success: false,
                        error: `网络错误：可能是CORS限制。\n\n建议：\n1. 检查API密钥和端点是否正确\n2. 某些API需要在服务器端调用\n3. 可以尝试使用代理服务器\n\n技术详情：${error.message}`
                    };
                }

                return {
                    success: false,
                    error: error.message
                };
            }
        }

        function loadApiConfigToModal() {
            const config = appState.apiConfig;

            // 绑定API相关事件监听器（每次打开模态框时重新绑定）
            bindApiEventListeners();

            // 加载当前配置到表单
            document.getElementById('apiProvider').value = config.provider || 'openai';
            document.getElementById('apiKey').value = config.apiKey || '';
            document.getElementById('apiEndpoint').value = config.endpoint || '';
            document.getElementById('contextLength').value = config.contextLength || 5;
            document.getElementById('contextValue').textContent = config.contextLength || 5;
            document.getElementById('responseDelay').value = config.responseDelay || 1000;
            document.getElementById('temperature').value = config.temperature || 0.7;

            // 更新字段（这会自动设置端点和模型列表）
            updateApiConfigFields();

            // 如果有保存的模型，设置它
            if (config.model) {
                document.getElementById('aiModel').value = config.model;
                updateModelHelp();
            }
        }

        function bindApiEventListeners() {
            // 直接绑定事件监听器，使用 onclick 等属性避免重复绑定
            const apiProvider = document.getElementById('apiProvider');
            const aiModel = document.getElementById('aiModel');
            const saveConfigBtn = document.getElementById('saveApiConfig');
            const testConnBtn = document.getElementById('testApiConnection');
            const contextLength = document.getElementById('contextLength');
            const toggleApiKey = document.getElementById('toggleApiKey');

            if (apiProvider) {
                apiProvider.onchange = updateApiConfigFields;
            }

            if (aiModel) {
                aiModel.onchange = updateModelHelp;
            }

            if (saveConfigBtn) {
                saveConfigBtn.onclick = saveApiConfig;
            }

            if (testConnBtn) {
                testConnBtn.onclick = testApiConnection;
            }

            if (contextLength) {
                contextLength.oninput = function() {
                    document.getElementById('contextValue').textContent = this.value;
                };
            }

            if (toggleApiKey) {
                toggleApiKey.onclick = toggleApiKeyVisibility;
            }
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.querySelector('#toggleApiKey i');

            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
                document.getElementById('toggleApiKey').title = '隐藏密钥';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
                document.getElementById('toggleApiKey').title = '显示密钥';
            }
        }

        // 用户信息编辑相关函数
        function loadUserInfoToModal() {
            const user = appState.user;

            // 加载当前用户信息到表单
            document.getElementById('userName').value = user.name || '用户';
            document.getElementById('userBio').value = user.bio || '';

            // 更新预览
            updateUserPreview();

            // 绑定头像上传事件
            const avatarInput = document.getElementById('userAvatar');
            avatarInput.onchange = function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // 临时保存头像数据，等保存时再应用
                        avatarInput.tempAvatarData = e.target.result;
                        updateUserPreview();
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            };

            // 绑定保存按钮事件
            const saveBtn = document.getElementById('saveUserInfo');
            saveBtn.onclick = saveUserInfo;

            // 绑定实时预览事件
            document.getElementById('userName').oninput = updateUserPreview;
            document.getElementById('userBio').oninput = updateUserPreview;
        }

        function updateUserPreview() {
            const nameInput = document.getElementById('userName');
            const bioInput = document.getElementById('userBio');
            const avatarInput = document.getElementById('userAvatar');

            const previewAvatar = document.querySelector('.preview-avatar');
            const previewName = document.querySelector('.preview-name');
            const previewBio = document.querySelector('.preview-bio');

            // 更新名称
            const name = nameInput.value.trim() || '用户';
            previewName.textContent = name;

            // 更新简介
            const bio = bioInput.value.trim() || 'AI角色扮演爱好者';
            previewBio.textContent = bio;

            // 更新头像
            if (avatarInput.tempAvatarData) {
                previewAvatar.innerHTML = `<img src="${avatarInput.tempAvatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" />`;
            } else if (appState.user.avatar && appState.user.avatar.startsWith('data:image')) {
                previewAvatar.innerHTML = `<img src="${appState.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" />`;
            } else {
                previewAvatar.textContent = (appState.user.avatar || name.charAt(0).toUpperCase());
            }
        }

        function saveUserInfo() {
            const nameInput = document.getElementById('userName');
            const bioInput = document.getElementById('userBio');
            const avatarInput = document.getElementById('userAvatar');

            const name = nameInput.value.trim();
            const bio = bioInput.value.trim();

            if (!name) {
                alert('请输入用户昵称');
                return;
            }

            // 更新用户信息
            appState.user.name = name;
            appState.user.bio = bio;

            // 如果有新头像，更新头像
            if (avatarInput.tempAvatarData) {
                appState.user.avatar = avatarInput.tempAvatarData;
            } else if (!appState.user.avatar || !appState.user.avatar.startsWith('data:image')) {
                // 如果没有图片头像，使用首字母
                appState.user.avatar = name.charAt(0).toUpperCase();
            }

            // 保存数据
            saveData();

            // 重新渲染当前聊天（如果有的话）
            if (appState.currentChat) {
                const chat = appState.chats.find(c => c.id === appState.currentChat);
                if (chat) {
                    renderMessages(chat.messages);
                }
            }

            // 关闭模态框
            document.getElementById('userInfoModal').classList.remove('active');
            alert('用户信息已保存');
        }

        // 全局预设相关函数
        function loadGlobalPresetToModal() {
            const preset = appState.globalPreset;

            // 加载对话风格设置
            document.getElementById('dialogStyleEnabled').checked = preset.dialogStyle.enabled;
            document.getElementById('dialogStylePrompt').value = preset.dialogStyle.prompt || '';

            // 加载状态栏设置
            document.getElementById('statusBarEnabled').checked = preset.statusBar.enabled;
            document.getElementById('statusBarPrompt').value = preset.statusBar.prompt || '';

            // 加载行为参数
            document.getElementById('globalContextLength').value = preset.contextLength || 5;
            document.getElementById('globalContextValue').textContent = preset.contextLength || 5;
            document.getElementById('globalResponseDelay').value = preset.responseDelay || 1000;

            // 绑定全局预设事件
            bindGlobalPresetEvents();

            // 更新字符计数
            updateDialogStyleCharCount();
            updateStatusBarCharCount();

            // 更新开关状态
            updatePresetSectionState();
        }

        function bindGlobalPresetEvents() {
            // 对话风格开关
            const dialogStyleToggle = document.getElementById('dialogStyleEnabled');
            const statusBarToggle = document.getElementById('statusBarEnabled');
            const dialogStylePrompt = document.getElementById('dialogStylePrompt');
            const statusBarPrompt = document.getElementById('statusBarPrompt');
            const contextLength = document.getElementById('globalContextLength');
            const saveBtn = document.getElementById('saveGlobalPreset');

            if (dialogStyleToggle) {
                dialogStyleToggle.onchange = updatePresetSectionState;
            }

            if (statusBarToggle) {
                statusBarToggle.onchange = updatePresetSectionState;
            }

            if (dialogStylePrompt) {
                dialogStylePrompt.oninput = updateDialogStyleCharCount;
                dialogStylePrompt.onpaste = function() {
                    setTimeout(updateDialogStyleCharCount, 10);
                };
            }

            if (statusBarPrompt) {
                statusBarPrompt.oninput = updateStatusBarCharCount;
                statusBarPrompt.onpaste = function() {
                    setTimeout(updateStatusBarCharCount, 10);
                };
            }

            if (contextLength) {
                contextLength.oninput = function() {
                    document.getElementById('globalContextValue').textContent = this.value;
                };
            }

            if (saveBtn) {
                saveBtn.onclick = saveGlobalPreset;
            }
        }

        function updatePresetSectionState() {
            const dialogStyleEnabled = document.getElementById('dialogStyleEnabled').checked;
            const statusBarEnabled = document.getElementById('statusBarEnabled').checked;
            const dialogStyleContent = document.getElementById('dialogStyleContent');
            const statusBarContent = document.getElementById('statusBarContent');

            if (dialogStyleContent) {
                if (dialogStyleEnabled) {
                    dialogStyleContent.classList.remove('disabled');
                } else {
                    dialogStyleContent.classList.add('disabled');
                }
            }

            if (statusBarContent) {
                if (statusBarEnabled) {
                    statusBarContent.classList.remove('disabled');
                } else {
                    statusBarContent.classList.add('disabled');
                }
            }
        }

        function updateDialogStyleCharCount() {
            const textarea = document.getElementById('dialogStylePrompt');
            const counter = document.getElementById('dialogStyleCharCount');
            if (textarea && counter) {
                const currentLength = textarea.value.length;
                counter.textContent = currentLength;

                if (currentLength > 450) {
                    counter.style.color = '#ff4d4f';
                } else if (currentLength > 400) {
                    counter.style.color = '#faad14';
                } else {
                    counter.style.color = '#666';
                }
            }
        }

        function updateStatusBarCharCount() {
            const textarea = document.getElementById('statusBarPrompt');
            const counter = document.getElementById('statusBarCharCount');
            if (textarea && counter) {
                const currentLength = textarea.value.length;
                counter.textContent = currentLength;

                if (currentLength > 270) {
                    counter.style.color = '#ff4d4f';
                } else if (currentLength > 240) {
                    counter.style.color = '#faad14';
                } else {
                    counter.style.color = '#666';
                }
            }
        }

        function saveGlobalPreset() {
            const dialogStyleEnabled = document.getElementById('dialogStyleEnabled').checked;
            const dialogStylePrompt = document.getElementById('dialogStylePrompt').value.trim();
            const statusBarEnabled = document.getElementById('statusBarEnabled').checked;
            const statusBarPrompt = document.getElementById('statusBarPrompt').value.trim();
            const contextLength = parseInt(document.getElementById('globalContextLength').value);
            const responseDelay = parseInt(document.getElementById('globalResponseDelay').value);

            // 更新全局预设
            appState.globalPreset = {
                dialogStyle: {
                    enabled: dialogStyleEnabled,
                    prompt: dialogStylePrompt
                },
                statusBar: {
                    enabled: statusBarEnabled,
                    prompt: statusBarPrompt
                },
                contextLength: contextLength,
                responseDelay: responseDelay
            };

            // 保存数据
            saveData();

            // 关闭模态框
            document.getElementById('globalPresetModal').classList.remove('active');
            alert('全局预设已保存');
        }
    </script>
</body>
</html>